<!DOCTYPE html>
<html>
<head>
    <title>Test Session Fix</title>
</head>
<body>
    <h1>Testing Session ID Fix</h1>
    <p>Check the console for results</p>
    
    <button onclick="clearOldUserId()">Clear Old User ID</button>
    <button onclick="generateNewSession()">Generate New Session</button>
    <button onclick="testAPI()">Test API Call</button>
    
    <div id="output"></div>
    
    <script>
        function updateDisplay() {
            const output = document.getElementById('output');
            const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
            const userId = localStorage.getItem('userId');
            const sessionId = localStorage.getItem('session_id');
            
            output.innerHTML = `
                <h3>Current State:</h3>
                <p>isAuthenticated: ${isAuthenticated}</p>
                <p>userId: ${userId || 'none'}</p>
                <p>sessionId: ${sessionId || 'none'}</p>
            `;
        }
        
        function clearOldUserId() {
            const userId = localStorage.getItem('userId');
            if (userId && userId.startsWith('user_')) {
                localStorage.removeItem('userId');
                console.log('Cleared old user ID:', userId);
            }
            updateDisplay();
        }
        
        function generateNewSession() {
            const sessionId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem('session_id', sessionId);
            console.log('Generated new session ID:', sessionId);
            updateDisplay();
        }
        
        async function testAPI() {
            const apiBase = 'https://p0qp0q.com';
            const params = new URLSearchParams();
            const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
            const userId = localStorage.getItem('userId');
            const sessionId = localStorage.getItem('session_id');
            
            if (isAuthenticated && userId && !userId.startsWith('user_')) {
                params.append('user_id', userId);
                console.log('Using user_id for authenticated user');
            } else if (sessionId) {
                params.append('session_id', sessionId);
                console.log('Using session_id for anonymous user');
            }
            
            console.log('API URL:', `${apiBase}/api/economy/state?${params}`);
            
            try {
                const response = await fetch(`${apiBase}/api/economy/state?${params}`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Success! Data:', data);
                    alert('API call successful! Check console for data.');
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    alert(`API call failed with status ${response.status}`);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Network error: ' + error.message);
            }
        }
        
        // Initialize display
        updateDisplay();
    </script>
</body>
</html>